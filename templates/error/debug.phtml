<?php
$this->layout = null;
$globals = [
    'request' => $_REQUEST,
    'session' => $_SESSION ?? [],
    'cookie' => $_COOKIE,
    'header' => function_exists('getallheaders') ? getallheaders() : [],
    'server' => $_SERVER,
    'env' => $_ENV
];
$rootDir = dirname($_SERVER['DOCUMENT_ROOT'] ?? __DIR__) . '/';
?>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Error</title>
    <style>
        /* Calmer, compact debug UI */
        html, body { box-sizing: border-box; width: 100vw; max-width: 100vw; overflow-x: hidden; }
        body { font-family: Inter, 'Segoe UI', Arial, sans-serif; background: #f4f6f8; color: #1f2937; margin: 0; }
        .debug-header { background: linear-gradient(180deg,#0f1724 0%,#0b1220 100%); color: #eef2ff; padding: 0.7rem 1rem; margin-bottom: 0; }
        .debug-header h1 { margin: 0; font-size: 1.25rem; font-weight: 600; letter-spacing: 0.2px; }
        .debug-header small { font-size: 0.82rem; color: #c7d2fe; }
        .debug-header .meta { font-size: 0.9rem; color: #dbeafe; margin-top: 0.35rem; }
        .debug-container {
            max-width: 100vw;
            width: 100%;
            margin: 0 auto;
            background: #ffffff;
            border-radius: 6px;
            box-shadow: 0 6px 18px rgba(12,20,29,0.06);
            padding: 1rem 1.2rem;
            box-sizing: border-box;
        }
        .section { margin-bottom: 1rem; }
        .section h2 { border-bottom: 1px solid #eef2f7; padding-bottom: 0.35rem; margin-bottom: 0.6rem; font-size: 1rem; color: #0b2545; }
        .error-info { margin: 0; }
        .error-info.compact { display: grid; grid-template-columns: auto 1fr auto 1fr; grid-auto-rows: minmax(1rem, auto); gap: 0.15rem 0.8rem; align-items: baseline; }
        .error-info.compact dt { font-weight: 600; color: #0b2545; margin: 0; white-space: nowrap; font-size: 0.86rem; }
        .error-info.compact dd { margin: 0; display: block; min-width: 0; word-break: break-word; font-size: 0.86rem; color: #334155; }
        /* full-width compact error bar */
        .error-bar { padding: 0.35rem 0.45rem; background: #ffddddff; border:1px solid #b07d7dff; border-radius:6px; margin-bottom:0.8rem; }
        .error-bar-inner { display:flex; gap:0.6rem; flex-wrap:wrap; align-items:center; }
        .error-bar .eb-item { background:transparent; padding:0.12rem 0.45rem; border-radius:4px; font-size:0.86rem; color:#0b2545; max-width:60vw; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
        .error-bar .eb-item strong { font-weight:600; margin-right:0.25rem; color:#0b2545; }
        .stack-table, .globals-table { width: 100%; border-collapse: collapse; font-size: 0.86rem; }
        .stack-table th, .stack-table td, .globals-table th, .globals-table td { border: 1px solid #eef2f6; padding: 0.25rem 0.5rem; }
        .stack-table th { background: #f8fafc; color: #0b2545; font-weight: 600; font-size: 0.82rem; }
        .stack-table tr.active { background: #f1f5f9; font-weight: 600; }
    .stack-table td, .stack-table th { word-break: break-all; white-space: pre-wrap; }
    /* muted vendor rows */
    .stack-table tr.vendor td { color: #6b7280; font-style: italic; opacity: 0.9; }
    .stack-table tr.vendor { background: transparent; }
        /* ensure the stack index column doesn't wrap */
        .stack-table th:first-child, .stack-table td:first-child {
            white-space: nowrap;
            width: 3ch;
            text-align: center;
            padding-left: 0.35rem;
            padding-right: 0.35rem;
        }
        .globals-table td.key { font-weight: 600; color: #0b2545; width: 28%; vertical-align: top; }
        .globals-table td.value { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, 'Courier New', monospace; font-size: 0.82rem; max-height: 180px; overflow: auto; background: #fbfdff; }
        .collapsible { cursor: pointer; background: transparent; border: 1px solid #eef4fb; outline: none; width: 100%; text-align: left; padding: 0.25rem 0.5rem; font-size: 0.88rem; margin-bottom: 0.2rem; border-radius: 4px; }
        .collapsible.active, .collapsible:hover { background: #f8fbff; }
        .content { display: none; padding: 0.4rem 0.6rem; background: #ffffff; border-radius: 0 0 6px 6px; border: 1px solid #eef4fb; }
        .content.open { display: block; }
        .badge { display: inline-block; background: #ffb020; color: #082032; border-radius: 6px; padding: 0.05rem 0.45rem; font-size: 0.78rem; margin-left: 0.5rem; }
        .alert { background: #fff8e6; color: #6b4b00; border: 1px solid #ffecb3; border-radius: 4px; padding: 0.5rem 0.8rem; margin-bottom: 1rem; font-size: 0.9rem; }
        pre { margin: 0; font-size: 0.82rem; line-height: 1.25; white-space: pre-wrap; word-break: break-word; }
        @media (max-width: 1200px) { .debug-container { padding: 0.75rem 1vw; } }
        @media (max-width: 900px) { .debug-container { padding: 0.5rem 0.6vw; } .debug-header { padding: 0.5rem 0.6vw; } }
        @media (max-width: 600px) { .debug-header, .debug-container { padding: 0.3rem 0.4vw; } .debug-container { border-radius: 0; } }
    </style>
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        document.querySelectorAll('.collapsible').forEach(function(btn) {
            btn.addEventListener('click', function() {
                var content = btn.nextElementSibling;
                content.classList.toggle('open');
                btn.classList.toggle('active');
            });
        });
    });
    </script>
</head>
<body>
    <div class="debug-header" style="margin-bottom:0;">
        <h1>Application Error <small>(Debug Mode)</small></h1>
        <div style="margin-top:0.5rem; font-size:1.1rem;">
            <b><?= $this->escape($exception->getMessage()) ?></b>
            <span style="margin-left:1.5rem;">in <b><?= $this->escape($exception->getFile()) ?></b> on line <b><?= $exception->getLine() ?></b></span>
        </div>
    </div>
    <div class="debug-container">
        <div class="error-bar">
            <div class="error-bar-inner">
                <span class="eb-item"><strong>Type</strong><?= $this->escape(get_class($exception)) ?></span>
                <span class="eb-item"><strong>Code</strong><?= $this->escape($exception->getCode()) ?></span>
                <span class="eb-item" title="<?= $this->escape($exception->getMessage()) ?>"><strong>Message</strong><?= $this->escape($exception->getMessage()) ?></span>
                <span class="eb-item" title="<?= $this->escape($exception->getFile()) ?>:<?= $exception->getLine() ?>"><strong>File</strong><?= $this->escape(str_replace($rootDir, '', $exception->getFile())) ?>:<?= $exception->getLine() ?></span>
            </div>
        </div>

        <div style="display: flex; gap: 2.5rem; align-items: flex-start; flex-wrap: wrap; min-width:0;">
            <div style="flex: 2 1 520px; min-width: 380px; min-width:0;">
                <div class="section">
                    <h2>Callback Stack</h2>
                    <table class="stack-table">
                        <thead>
                            <tr><th>#</th><th>File</th><th>Line</th><th>Function</th></tr>
                        </thead>
                        <tbody>
                        <?php $traces = $exception->getTrace(); ?>
                        <?php
                            $exFileFull = $exception->getFile();
                            $exFileRel = $this->escape(str_replace($rootDir, '', $exFileFull));
                            $exIsVendor = (strpos($exFileFull, DIRECTORY_SEPARATOR . 'vendor' . DIRECTORY_SEPARATOR) !== false) || (strpos($exFileFull, '/vendor/') !== false);
                        ?>
                        <tr class="active <?= $exIsVendor ? 'vendor' : '' ?>">
                            <td>0</td>
                            <td><?= $exFileRel ?></td>
                            <td><?= $exception->getLine() ?></td>
                            <td><?= isset($traces[0]['function']) ? $this->escape($traces[0]['function']) : '' ?></td>
                        </tr>
                        <?php foreach($traces as $i => $trace): if(isset($trace['file'])):
                            $tFileFull = $trace['file'];
                            $tFileRel = $this->escape(str_replace($rootDir, '', $tFileFull));
                            $tIsVendor = (strpos($tFileFull, DIRECTORY_SEPARATOR . 'vendor' . DIRECTORY_SEPARATOR) !== false) || (strpos($tFileFull, '/vendor/') !== false);
                        ?>
                        <tr class="<?= $tIsVendor ? 'vendor' : '' ?>">
                            <td><?= $i+1 ?></td>
                            <td><?= $tFileRel ?></td>
                            <td><?= $this->escape($trace['line'] ?? '') ?></td>
                            <td><?= $this->escape($trace['function'] ?? '') ?></td>
                        </tr>
                        <?php endif; endforeach; ?>
                        </tbody>
                    </table>
                </div>
            </div>
            <div style="flex: 1 1 320px; min-width: 260px; min-width:0;">
                <div class="section">
                    <h2>Global Variables</h2>
                    <?php foreach($globals as $gkey => $gvars): ?>
                        <button class="collapsible">[<?= strtoupper($gkey) ?>] <span class="badge"><?= is_array($gvars) ? count($gvars) : 0 ?></span></button>
                        <div class="content">
                            <table class="globals-table">
                                <tbody>
                                <?php if($gvars): foreach($gvars as $key => $val): ?>
                                    <tr>
                                        <td class="key"><?= $this->escape($key) ?></td>
                                        <td class="value"><pre><?= htmlspecialchars(print_r($val, true)) ?></pre></td>
                                    </tr>
                                <?php endforeach; endif; ?>
                                </tbody>
                            </table>
                        </div>
                    <?php endforeach; ?>
                </div>
            </div>
        </div>
    </div>
</body>
</html>
